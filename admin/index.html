<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Georgia', serif; background: #f8f9fa; padding: 20px; display: none; }
        .admin-container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #d63447; text-align: center; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; background: #fef1f2; border-radius: 10px; text-align: center; border: 1px solid #ffdde1; }
        .stat-card h3 { color: #d63447; font-size: 24px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .status-tag { font-weight: bold; font-size: 13px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-reactivate { background: #4285f4; color: white; }
        .btn-sync { background: #34a853; color: white; width: 100%; margin-top: 15px; }
        #statusMsg { text-align: center; margin-top: 15px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="admin-container">
        <h2>Admin Dashboard</h2>
        <div class="stats">
            <div class="stat-card"><h3 id="redeemedCount">0</h3><p>Used</p></div>
            <div class="stat-card"><h3 id="availableCount">0</h3><p>Available</p></div>
        </div>
        
        <div id="voucherList"></div>
        
        <button class="btn btn-sync" onclick="syncToSheets()">Force Push Changes</button>
        <p id="statusMsg"></p>
    </div>

    <script>
        const ADMIN_PASSWORD = "taiwan_number_one"; 
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXF7Lrs1udVO_1dpqoGA-zXdEU5r6mFLhz13mUq8awCyZHM8GkEarjkpzwcWYiKtIr/exec";

        const entry = prompt("Admin Password:");
        if (entry === ADMIN_PASSWORD) {
            document.body.style.display = "block";
        } else {
            alert("Unauthorized");
            window.location.href = "../index.html";
        }

        const voucherData = [
            { id: 1, title: "breakfast in bed" }, { id: 2, title: "massage" }, { id: 3, title: "big hug" },
            { id: 4, title: "bath session" }, { id: 5, title: "passionate kiss" }, { id: 6, title: "make-out session" },
            { id: 7, title: "movie night" }, { id: 8, title: "weekend getaway" }, { id: 9, title: "date night" },
            { id: 10, title: "cuddle session" }, { id: 11, title: "30 min nap" }, { id: 12, title: "yes day" }
        ];

        function refreshUI() {
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            let used = 0;
            
            const html = voucherData.map(v => {
                const isUsed = status[v.id]?.redeemed || false;
                if(isUsed) used++;
                return `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:bold">${v.title}</div>
                            <div class="status-tag" style="color:${isUsed ? '#d63447' : '#34a853'}">
                                ${isUsed ? 'Status: Used' : 'Status: Available'}
                            </div>
                        </div>
                        ${isUsed ? `<button class="btn btn-reactivate" onclick="reactivate(${v.id})">Re-activate</button>` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('voucherList').innerHTML = html;
            document.getElementById('redeemedCount').innerText = used;
            document.getElementById('availableCount').innerText = voucherData.length - used;
        }

        // NEW: Load current status from Google Sheets on startup
        async function loadFromSheets() {
            const msg = document.getElementById('statusMsg');
            msg.innerText = "Loading current status...";
            try {
                const res = await fetch(SCRIPT_URL + "?action=load");
                const data = await res.json();
                if (data.vouchers) {
                    const status = {};
                    data.vouchers.forEach(v => { 
                        status[v.id] = { redeemed: v.redeemed, redeemedDate: v.redeemedDate }; 
                    });
                    localStorage.setItem('voucherStatus', JSON.stringify(status));
                    refreshUI();
                    msg.innerText = "✓ Status loaded from cloud";
                    setTimeout(() => { msg.innerText = ""; }, 2000);
                }
            } catch (e) {
                msg.innerText = "Offline: Showing local data";
                refreshUI();
            }
        }

        function reactivate(id) {
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            status[id] = { redeemed: false, redeemedDate: null };
            localStorage.setItem('voucherStatus', JSON.stringify(status));
            refreshUI();
            syncToSheets(); 
        }

        async function syncToSheets() {
            const msg = document.getElementById('statusMsg');
            msg.innerText = "Syncing...";
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            const data = voucherData.map(v => ({
                id: v.id, title: v.title,
                redeemed: status[v.id]?.redeemed || false,
                redeemedDate: status[v.id]?.redeemedDate || ''
            }));

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'sync', data: data })
                });
                msg.innerText = "✓ Synced!";
                setTimeout(() => { msg.innerText = ""; }, 3000);
            } catch (e) {
                msg.innerText = "Error syncing.";
            }
        }

        // Start by loading from the cloud
        loadFromSheets();
    </script>
</body>
</html>