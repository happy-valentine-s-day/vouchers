<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vouchers</title>
    <style>
        body { font-family: 'Georgia', serif; background: #f0f2f5; padding: 20px; display: none; }
        .admin-box { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { color: #d63447; text-align: center; margin-bottom: 20px; }
        .stats { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: #fff5f6; padding: 15px; text-align: center; border-radius: 10px; border: 1px solid #ffdde1; }
        .stat-card h3 { font-size: 24px; color: #d63447; }
        
        /* List Styles */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        .item-info { display: flex; flex-direction: column; }
        .status-tag { font-weight: bold; font-size: 12px; margin-top: 4px; }
        
        /* Buttons */
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .btn-reactivate { background: #4285f4; color: white; }
        .btn-reactivate:hover { background: #3367d6; }
        .btn-sync { background: #34a853; color: white; width: 100%; padding: 12px; margin-top: 20px; font-size: 14px; }
        .btn-reset { background: #f8f9fa; color: #888; margin-top: 30px; font-size: 12px; text-decoration: underline; width: 100%; text-align: center; }
    </style>
</head>
<body>
    <div class="admin-box">
        <h2>Admin Dashboard</h2>
        <div class="stats">
            <div class="stat-card"><h3 id="totalCount">12</h3><p>Vouchers</p></div>
            <div class="stat-card"><h3 id="redeemedCount">0</h3><p>Used</p></div>
        </div>
        
        <div id="voucherList"></div>
        
        <button class="btn btn-sync" onclick="syncToSheets()">Force Push to Sheets</button>
        <button class="btn btn-reset" onclick="resetVouchers()">Reset All to Available</button>
        <p id="msg" style="text-align:center; font-size: 12px; margin-top: 10px; color: #666;"></p>
    </div>

    <script>
        const ADMIN_PASSWORD = "taiwan_number_one"; // CHANGE THIS PASSWORD!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXF7Lrs1udVO_1dpqoGA-zXdEU5r6mFLhz13mUq8awCyZHM8GkEarjkpzwcWYiKtIr/exec";

        // Password Gate
        const entry = prompt("Enter Admin Password:");
        if (entry === ADMIN_PASSWORD) {
            document.body.style.display = "block";
        } else {
            alert("Wrong password!");
            window.location.href = "../index.html";
        }

        const voucherData = [
            { id: 1, title: "breakfast in bed" }, { id: 2, title: "massage" }, { id: 3, title: "big hug" },
            { id: 4, title: "bath session" }, { id: 5, title: "passionate kiss" }, { id: 6, title: "make-out session" },
            { id: 7, title: "movie night" }, { id: 8, title: "weekend getaway" }, { id: 9, title: "date night" },
            { id: 10, title: "cuddle session" }, { id: 11, title: "30 min nap" }, { id: 12, title: "yes day" }
        ];

        function refreshAdmin() {
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            let usedCount = 0;
            
            const html = voucherData.map((v) => {
                const isUsed = status[v.id]?.redeemed || false;
                if(isUsed) usedCount++;
                
                return `
                    <div class="list-item">
                        <div class="item-info">
                            <span>${v.title}</span>
                            <span class="status-tag" style="color:${isUsed ? '#d63447' : '#34a853'}">
                                ${isUsed ? 'Used' : 'Available'}
                            </span>
                        </div>
                        ${isUsed ? `<button class="btn btn-reactivate" onclick="reactivate(${v.id})">Re-activate</button>` : ''}
                    </div>`;
            }).join('');
            
            document.getElementById('voucherList').innerHTML = html;
            document.getElementById('redeemedCount').innerText = usedCount;
        }

        // --- NEW RE-ACTIVATE FUNCTION ---
        function reactivate(id) {
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            status[id] = { redeemed: false, redeemedDate: null };
            localStorage.setItem('voucherStatus', JSON.stringify(status));
            
            refreshAdmin();
            syncToSheets(); // Automatically push to Google Sheets
        }

        async function syncToSheets() {
            document.getElementById('msg').innerText = "Syncing with Google Sheets...";
            const status = JSON.parse(localStorage.getItem('voucherStatus') || '{}');
            
            // Format data for the Google Script
            const data = voucherData.map((v) => ({
                id: v.id,
                title: v.title,
                redeemed: status[v.id]?.redeemed || false,
                redeemedDate: status[v.id]?.redeemedDate || ''
            }));

            try {
                // We use POST with 'no-cors' to avoid browser blocks, 
                // but we send the data as a parameter for the Google Script to read
                const formData = new URLSearchParams();
                formData.append('action', 'sync');
                formData.append('data', JSON.stringify(data));

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                document.getElementById('msg').innerText = "âœ“ Changes Saved Successfully";
            } catch(e) {
                document.getElementById('msg').innerText = "Error syncing to Sheets.";
            }
        }

        function resetVouchers() {
            if(confirm("Mark everything as available? This will update Google Sheets too.")) {
                const fresh = {};
                voucherData.forEach((v) => fresh[v.id] = {redeemed: false, redeemedDate: null});
                localStorage.setItem('voucherStatus', JSON.stringify(fresh));
                refreshAdmin();
                syncToSheets();
            }
        }

        refreshAdmin();
    </script>
</body>
</html>